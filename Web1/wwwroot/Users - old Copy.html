<html>
<head>
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <title>Service Fabric with WebSockets Demo</title>
   <script src="Scripts/jquery-1.6.4.min.js"></script>
   <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
   <!--Reference the autogenerated SignalR hub script. -->
   <script src="signalr/hubs"></script>
   <!-- Bootstrap -->
   <link href="Content/bootstrap.css" rel="stylesheet">

   <style type="text/css">
      .auto-style1 {
         text-align: center;
         font-size: large;
      }

      .auto-style2 {
         font-size: 16pt;
      }

      .auto-style3 {
         font-size: large;
      }

      table {
         margin-left: 2cm;
      }


   </style>

</head>
<body>
   <p>
      <br />
   </p>
   <div class="auto-style1">
      This is is the list of currently logged users with their status refreshed in real time.
   </div>
   <p>
      &nbsp;
   </p>

   <table>
      <thead>
         <tr>
            <th width="100">User</th>
            <th>Status</th>
         </tr>
      </thead>
      <tbody id='mytbody'>
         <!--
         <tr>
            <td>Prova     a</td>
            <td>creato per prova</td>
         </tr>
            -->
         <tr> <td>u1</td> <td id='u1'>Alive from s1 seconds</td> </tr>
         <tr> <td>pep</td> <td id='pep'>Alive from 418 seconds</td> </tr>
         <tr> <td>gigi</td> <td id='gigi'>Alive from 483 seconds</td> </tr>
      </tbody>
   </table>


      <script>
         $(function () {
            var users = [];

            users.push({ username: "u1", seconds: "s1"});

            var connection = $.hubConnection();
            var sighub = connection.createHubProxy("sigrHub");
            sighub.on("broadcastMessage", function (username, seconds) {
               // Add the message to the page.
               var found_user = false;
               for (ndx in users) {
                  if (users[ndx].username == username) {
                     found_user = true;
                     users[ndx].seconds = seconds;
                     $('#' + username).html(BuildUserStatusMessage(seconds));
                  }
               }
               if (!found_user) {
                  users.push({ username: username, seconds: seconds });
                  BuildUserTable();
               }
            });


            connection.start()
                .done(function () {
                   $('#servermsglist').append('Now connected, connection ID=' + connection.id);
                })
                .fail(function () {
                   $('#servermsglist').append('failed to connect');
                });


            function BuildUserStatusMessage(seconds) {
               return "Alive from " + seconds + " seconds"
            }


            function BuildUserTable() {
               var bodystr = "";
               for (ndx in users) {
                  bodystr += "<tr> <td>" + users[ndx].username + "</td> <td id='" + users[ndx].username + "'>" + 
                     BuildUserStatusMessage(users[ndx].seconds) + "</td> </tr>";
               }
               $('#mytbody').replaceWith(bodystr);
            }


         });
      </script>
</body>
</html>














